name: Split & Publish

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'plugins/**'
      - 'themes/**'
      - '.github/workflows/split-publish.yml'

jobs:
  split:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Configure git
        run: |
          git config user.name "TentaBot"
          git config user.email "actions@github.com"

      - name: Verify split token
        env:
          SPLIT_TOKEN: ${{ secrets.SPLIT_TOKEN }}
        run: |
          set -euo pipefail

          if [ -z "${SPLIT_TOKEN:-}" ]; then
            echo "Missing SPLIT_TOKEN secret (PAT with repo write access)."
            exit 1
          fi

          login="$(curl -s -H "Authorization: token ${SPLIT_TOKEN}" https://api.github.com/user | python3 -c 'import json,sys; print((json.load(sys.stdin).get("login") or ""))' 2>/dev/null || true)"

          if [ -z "${login}" ]; then
            echo "Unable to validate SPLIT_TOKEN. Check PAT permissions and SSO authorization."
            exit 1
          fi

          echo "Using split token for: ${login}"

      - name: Split and push plugins/themes
        env:
          SPLIT_TOKEN: ${{ secrets.SPLIT_TOKEN }}
          SPLIT_ORG: ${{ secrets.SPLIT_ORG }}
          SPLIT_PLUGIN_PREFIX: ${{ vars.SPLIT_PLUGIN_PREFIX }}
          SPLIT_THEME_PREFIX: ${{ vars.SPLIT_THEME_PREFIX }}
        run: |
          set -euo pipefail

          if [ -z "${SPLIT_TOKEN:-}" ]; then
            echo "Missing SPLIT_TOKEN secret (PAT with repo write access)."
            exit 1
          fi

          ORG="${SPLIT_ORG:-${GITHUB_REPOSITORY_OWNER}}"
          PLUGIN_PREFIX="${SPLIT_PLUGIN_PREFIX:-plugin-}"
          THEME_PREFIX="${SPLIT_THEME_PREFIX:-theme-}"

          BEFORE="$(python3 -c 'import json,os; p=os.environ.get("GITHUB_EVENT_PATH",""); print((json.load(open(p,"r",encoding="utf-8")).get("before","") if p and os.path.exists(p) else ""))' 2>/dev/null || true)"

          if [ -z "${BEFORE:-}" ] || [ "${BEFORE:-}" = "0000000000000000000000000000000000000000" ]; then
            BEFORE="$(git rev-parse HEAD^ 2>/dev/null || echo '')"
          fi

          split_push() {
            local prefix="$1"
            local repo="$2"
            local branch="main"
            local ref="split-$(echo "$repo" | tr '/' '-' | tr -cd '[:alnum:]-')"

            echo "Splitting ${prefix} -> ${ORG}/${repo}.git" >&2
            git subtree split --prefix="$prefix" -b "$ref" >&2
            local sha
            sha="$(git rev-parse "$ref")"
            git push --force "https://x-access-token:${SPLIT_TOKEN}@github.com/${ORG}/${repo}.git" "$ref":"$branch" >&2
            echo "${sha}"
            git branch -D "$ref" >&2
          }

          read_version_file() {
            local path="$1"
            python3 -c 'import json,sys; p=sys.argv[1]; data=json.load(open(p,"r",encoding="utf-8")); print((data.get("version") or "").strip())' "$path" 2>/dev/null || true
          }

          read_version_stdin() {
            python3 -c 'import json,sys; data=json.load(sys.stdin); print((data.get("version") or "").strip())' 2>/dev/null || true
          }

          tag_version() {
            local repo="$1"
            local version="$2"
            local sha="$3"
            local prev_version="$4"

            if [ -z "${version:-}" ]; then
              return
            fi

            if [ -n "${prev_version:-}" ] && [ "${prev_version}" = "${version}" ]; then
              echo "Version unchanged (${version}) for ${repo}, skipping tag/release."
              return
            fi

            local tag="v${version}"
            local remote="https://x-access-token:${SPLIT_TOKEN}@github.com/${ORG}/${repo}.git"
            local previous_tag

            if git ls-remote --tags "$remote" "refs/tags/${tag}" | grep -q "${tag}"; then
              echo "Tag ${tag} already exists for ${repo}, skipping."
              return
            fi

            previous_tag="$(git ls-remote --tags "$remote" \
              | awk '{print $2}' \
              | sed 's#refs/tags/##' \
              | sed 's#\\^{}##' \
              | sort -V \
              | tail -n 1)"

            git tag -d "${tag}" >/dev/null 2>&1 || true
            git tag -a "${tag}" -m "${repo} ${tag}" "${sha}"
            git push "$remote" "refs/tags/${tag}"
            git tag -d "${tag}"

            local notes_file
            notes_file="$(mktemp)"

            if [ -n "${previous_tag:-}" ]; then
              git fetch "$remote" "refs/tags/${previous_tag}:refs/tags/${previous_tag}" >/dev/null 2>&1 || true
              git log --pretty=format:'- %s (%h)' "${previous_tag}..${sha}" >"$notes_file" 2>/dev/null || true
            else
              git log --pretty=format:'- %s (%h)' -n 50 "${sha}" >"$notes_file" 2>/dev/null || true
            fi

            if [ ! -s "$notes_file" ]; then
              echo "No changes recorded." >"$notes_file"
            fi

            GH_TOKEN="${SPLIT_TOKEN}" gh release create "${tag}" \
              -R "${ORG}/${repo}" \
              -t "${repo} ${tag}" \
              -F "$notes_file" || true

            rm -f "$notes_file"
          }

          for path in plugins/*/*; do
            [ -f "$path/composer.json" ] || continue
            name="$(basename "$path")"
            repo="${PLUGIN_PREFIX}${name}"
            version="$(read_version_file "$path/tentapress.json")"
            prev_version=""
            if [ -n "${BEFORE:-}" ]; then
              prev_version="$(git show "${BEFORE}:${path}/tentapress.json" 2>/dev/null | read_version_stdin || true)"
            fi
            if [ -z "${version:-}" ]; then
              echo "Missing version in ${path}/tentapress.json for ${repo}."
              exit 1
            fi
            echo "Version for ${repo}: ${version} (prev: ${prev_version:-none})"
            sha="$(split_push "$path" "$repo")"
            tag_version "$repo" "$version" "$sha" "$prev_version"
          done

          for path in themes/*/*; do
            [ -f "$path/tentapress.json" ] || continue
            name="$(basename "$path")"
            repo="${THEME_PREFIX}${name}"
            version="$(read_version_file "$path/tentapress.json")"
            prev_version=""
            if [ -n "${BEFORE:-}" ]; then
              prev_version="$(git show "${BEFORE}:${path}/tentapress.json" 2>/dev/null | read_version_stdin || true)"
            fi
            if [ -z "${version:-}" ]; then
              echo "Missing version in ${path}/tentapress.json for ${repo}."
              exit 1
            fi
            echo "Version for ${repo}: ${version} (prev: ${prev_version:-none})"
            sha="$(split_push "$path" "$repo")"
            tag_version "$repo" "$version" "$sha" "$prev_version"
          done
